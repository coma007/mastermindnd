package userActivity;

import com.ftn.sbnz.model.events.enums.AddCampaignType
import com.ftn.sbnz.model.events.AddCampaignEvent
import java.util.List
import java.util.Map
import com.ftn.sbnz.model.models.enums.Level;
import com.ftn.sbnz.model.models.User;
import com.ftn.sbnz.model.models.UserActivity;
import com.ftn.sbnz.model.models.Campaign;

import static java.util.stream.Collectors.*
import java.util.HashMap
import com.ftn.sbnz.model.models.enums.GameplayStyle
import com.ftn.sbnz.model.models.enums.Theme;

rule "save campaign"
salience 10
no-loop when
    AddCampaignEvent(
    $user: user,
    $campaign: campaign,
    type == AddCampaignType.SAVE
    )
    $wishlist: UserActivity() from $user.getWishlist()
then
    modify($wishlist) {
        addCampaign($campaign)
    };
end

rule "like campaign"
salience 5
no-loop when
    AddCampaignEvent(
    $user: user,
    $campaign: campaign,
    type == AddCampaignType.LIKE
    )
    $preference: UserActivity() from $user.getPreference()
then
    modify($preference) {
        addCampaign($campaign)
    };
end

rule "play campaign"
salience 5
no-loop when
    AddCampaignEvent(
    $user: user,
    $campaign: campaign,
    type == AddCampaignType.PLAY
    )
    $history: UserActivity() from $user.getHistory()
then
    modify($history) {
        addCampaign($campaign)
    };
end

rule 'is ready for recommendation from history'
salience 3
when
    AddCampaignEvent(
    $user: user,
    type == AddCampaignType.PLAY
    )
    $history: UserActivity(
    $playedCampaigns: getCampaigns(),
    $level: getBestLevel(),
    $style: getBestStyle(),
    $theme: getBestTheme()
    ) from $user.getHistory()
    Number(intValue % 2 == 0, intValue != 0) from $playedCampaigns.size()
    $campaigns : List() from collect(Campaign())
then
    Campaign cam = null;
    for (Object o : $campaigns) {
        Campaign c = (Campaign) o;
        if (c.getGameplayStyle() == $style
        && c.getLevel() == $level
        && c.getTheme() == $theme)
            {
                cam = c;
                break;
            }
    }
    modify($user){recommendNew(cam)}
end

rule 'is ready for recommendation from wishlist'
salience 3
no-loop when
    AddCampaignEvent(
    $user: user,
    $campaign: campaign,
    type == AddCampaignType.SAVE
    )
    $wishlist: UserActivity(
        $savedCampaigns: getCampaigns(),
        $level: getBestLevel(),
        $style: getBestStyle(),
        $theme: getBestTheme()
    ) from $user.getWishlist()
    Number(intValue % 2 == 0, intValue != 0) from $savedCampaigns.size()
    $campaigns : List() from collect(Campaign())
then
    Campaign cam = null;
    for (Object o : $campaigns) {
        Campaign c = (Campaign) o;
        if (c.getGameplayStyle() == $style
        && c.getLevel() == $level
        && c.getTheme() == $theme)
            {
                cam = c;
                break;
            }
    }
    modify($user){recommendNew(cam)}
end

rule 'is ready for recommendation from preference'
salience 3
no-loop when
    AddCampaignEvent(
    $user: user,
    $campaign: campaign,
    type == AddCampaignType.LIKE
    )
    $preference: UserActivity(
        $likedCampaigns: getCampaigns(),
        $level: getBestLevel(),
        $style: getBestStyle(),
        $theme: getBestTheme()
    ) from $user.getPreference()
    Number(intValue % 2 == 0, intValue != 0) from $likedCampaigns.size()
    $campaigns : List() from collect(Campaign())
then
    Campaign cam = null;
    for (Object o : $campaigns) {
        Campaign c = (Campaign) o;
        if (c.getGameplayStyle() == $style
        && c.getLevel() == $level
        && c.getTheme() == $theme)
            {
                cam = c;
                break;
            }
    }
    modify($user){recommendNew(cam)}
end

rule 'playing a lot in the last month, here is some more'
when
    $user : User()
    $theme : Theme()
    Number(intValue > 1) from accumulate(
    $event: AddCampaignEvent(
    $user == user,
    $theme == campaign.getTheme(),
    type == AddCampaignType.SAVE),
    count($event)
    )
then
    System.out.println("Enough events");
end